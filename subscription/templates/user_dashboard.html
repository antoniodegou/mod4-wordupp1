{% extends "core/base.html" %}

{% block title %}User Dashboard{% endblock %}

{% block content %}
{% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}
<h1>Welcomea, {{ user.username }}</h1>

<ul class="nav nav-tabs" id="userTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Profile</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" id="subscription-tab" data-bs-toggle="tab" href="#subscription" role="tab" aria-controls="subscription" aria-selected="false">Subscription</a>
  </li>
</ul>

<div class="tab-content" id="userTabsContent">
  <!-- Dashboard Tab -->
  <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
    <h2>Dashboard</h2>
    <p>Here you can manage your subscriptions and view your data.</p>
  </div>
  
  <!-- Profile Tab -->
  <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
    <h2>Profile</h2>
    <p>Welcome, {{ user.username }}!</p>
    <p>Email: {{ user.email }}</p>
    <a href="{% url 'logout' %}">Logout</a>
  </div>
  
  <!-- Subscription Tab -->
  <div class="tab-pane fade" id="subscription" role="tabpanel" aria-labelledby="subscription-tab">

    <h2>Create Subscription</h2>
    <form id="subscription-form" method="post" action="{% url 'dashboard' %}" >

      {% csrf_token %}
      {{ form }}
 
      <button id="stripe-button" type="submit" >Pay with Stripe</button>
      <button id="subscribe-button" type="submit" style="display:none;">Subscribe</button>

    </form>
 
    
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
// Initialize Stripe
// Initialize Stripe
var stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");

// document.addEventListener("DOMContentLoaded", function () {
  var form = document.getElementById("subscription-form");
  var stripeButton = document.getElementById("stripe-button");
  var subscribeButton = document.getElementById("subscribe-button");

  // Show or hide the Stripe button based on the plan selected
  form.addEventListener("change", function() {
    var planSelected = form.elements["stripe_plan_id"].value;
    if (planSelected === "premium") {
      stripeButton.style.display = "inline";
      subscribeButton.style.display = "none";
    } else {
      stripeButton.style.display = "none";
      subscribeButton.style.display = "inline";
    }
  });

  // Stripe button click event
// Stripe button click event
stripeButton.addEventListener("click", function (event) {
  // Comment out this line for debugging
  event.preventDefault();  // Prevent default form submission

  console.log("Stripe button clicked");

  var selectedPlan = document.querySelector('input[name="stripe_plan_id"]:checked').value;

  if (selectedPlan === 'premium') {
    var sessionId = "{{ stripe_session_id }}";  // Assuming that `stripe_session_id` is being passed correctly to your template
    console.log(sessionId);
    
    if (sessionId) {
      console.log("Form submitting...");
      stripe.redirectToCheckout({
        sessionId: sessionId
      }).then(function (result) {
        if (result.error) {
          // Show error to the user
          alert(result.error.message);
        }
      });
    } else {
      alert("An error occurred. Please try again.");
    }
  } else {
    form.submit();  // Submit the form for the free plan
  }
});

// });


    </script>
    
{% endblock %}


{% block extra_js %}

{% endblock %}